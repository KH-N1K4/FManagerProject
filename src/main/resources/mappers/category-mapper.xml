<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="categoryMapper">


	<resultMap type="Service" id="service_rm">
    	 <id property="serviceNo" column="SERVICE_NO"/>													<!-- 서비스 번호 SEQUENCE: SEQ_SERVICE_NO -->	
    		   		
	      <result property="serviceTitle" column="SERVICE_TITLE" />								<!-- 서비스 제목 -->							
	      <result property="serviceSummary" column="SERVICE_SUMMARY" />						<!-- 서비스 한 줄 요약 -->
	      <result property="serviceContent" column="SERNICE_CONTENT" />						<!-- 서비스 내용 -->
	      <result property="servicePrice" column="SERVICE_PRICE"/>								<!-- 서비스 가격 -->
	      <result property="servicePriceString" column="SERVICE_PRICE_STRING"/>		<!-- 서비스 가격 문자 형태 1,000-->
	      <result property="serviceEditNum" column="SERVICE_EDIT_NUM"/>						<!-- 서비스 수정 횟수 -->
	      <result property="serviceWorkPeriod" column="SERVICE_WORK_PERIOD" />		<!-- 서비스 작업 일수 -->
	      <result property="serviceCreateDate" column="SERVICE_CREATE_DATE" />		<!-- 서비스 작업 일수 -->
	      <result property="requestFilePath" column="REQUEST_FILE_PATH" />		<!-- 서비스 작업 일수 -->
	     
	      
	         <!-- 카테고리 -->
	      <result property="mainCategoryNo" column="MAIN_CATEGORY_NO" />								<!-- 메인 1카테고리 -->
	      <result property="mainCategoryName" column="MAIN_CATEGORY_NAME" />						<!-- 메인 1카테고리 이름 -->
	      <result property="subCategoryNo" column="SUB_CATEGORY_NO" />									<!-- 메인 2카테고리 -->
	      <result property="subCategoryName" column="SUB_CATEGORY_NAME" />							<!-- 메인 2카테고리 이름  -->
	      <result property="thirdCategoryNo" column="THIRD_CATEGORY_NO" />							<!-- 메인 3카테고리 -->	
	      <result property="thirdCategoryName" column="THIRD_CATEGORY_NAME" />					<!-- 메인 3카테고리 이름-->
	      
	      <result property="memberName" column="MEMBER_NAME" />					
	      <result property="memberProfile" column="MEMBER_PROFILE" />			
	      <result property="freelancerNo" column="FREELANCER_NO" />				
	      <result property="serviceDeleteFL" column="SERVICE_DEL_FL" />				
	      <result property="likeCheckFL" column="LIKE_CHECK_FL" />				
	      
	      
	      
	      
	      <collection property="imageFileList" 
	      javaType="java.util.ArrayList" ofType="ImageFile"
	      select="selectImageFileList"
	      column="SERVICE_NO"/> 
	      
	      
	     <!--  <collection property="commentList" 
	      javaType="java.util.ArrayList" ofType="Comment"
	      select="selectCommentList"
	      column="BOARD_NO"/> -->
	      
	      
    </resultMap>
    
    
  <resultMap type="ImageFile" id="imageFile_rm">
      <id property="imageFileNo" column="REQUEST_FILE_NO"/>
      <result property="imageFilePath" column="REQUEST_FILE_PATH"/>
      
      <result property="serviceNo" column="SERVICE_NO"/>
   </resultMap>
   
   
  <resultMap type="AskService" id="askService_rm">
      <id property="serviceInquiryNo" column="SERVICE_INQUIRY_NO"/>
      <result property="serviceInquiryContent" column="SERVICE_INQUIRY_CONTENT"/>
      <result property="memberNo" column="MEMBER_NO"/>
      <result property="serviceNo" column="SERVICE_NO"/>
      <result property="serviceTitle" column="SERVICE_TITLE"/>
      <result property="serviceSummary" column="SERVICE_SUMMARY"/>
      <result property="requestFilePath" column="REQUEST_FILE_PATH" />		<!-- 서비스 작업 일수 -->
   </resultMap>


  <select id="selectMainCategoryList" resultType="map">
 	SELECT * FROM MAIN_CATEGORY
 	ORDER BY 1
 
 </select>
 
 
  <select id="selectSubCategoryList" resultType="map">
 
 	SELECT * FROM SUB_CATEGORY
 	ORDER BY 1
 </select>
  <select id="selectThirdCategoryList" resultType="map">
 
 	SELECT * FROM CATEGORY
 	ORDER BY 1
 </select>
 
 <select id="selectBoardList" resultMap="service_rm"> 
	
		SELECT SERVICE_NO,
		
		<if test='memberNo!=null'>
		CASE WHEN MEMBER_NO = #{memberNo} THEN 'Y' ELSE 'N' END AS LIKE_CHECK_FL,
		</if>
	
		SERVICE_TITLE,SERVICE_SUMMARY,SERVICE_PRICE,
			THIRD_CATEGORY_NO,FREELANCER_NO,REQUEST_FILE_NO,REQUEST_FILE_PATH,MAIN_CATEGORY_NO
		FROM (SELECT * 
			FROM SERVICE
			LEFT JOIN CATEGORY USING(THIRD_CATEGORY_NO)
			LEFT JOIN SUB_CATEGORY USING(SUB_CATEGORY_NO))
		<if test='memberNo!=null'>
			LEFT JOIN (SELECT * FROM "LIKE" WHERE MEMBER_NO=#{memberNo}) USING(SERVICE_NO)
		</if>
		LEFT JOIN (SELECT s.*,
		ROW_NUMBER() OVER (PARTITION BY SERVICE_NO ORDER BY REQUEST_FILE_NO) rum
		FROM SERVICE_FILE s) USING(SERVICE_NO)
		WHERE RUM = 1
		AND MAIN_CATEGORY_NO=#{mainCategoryNo}
		AND SERVICE_DEL_FL='N'
		AND SERVICE_STATUS=2
 </select>
 	
 	
 	
 	<select id="viewService" resultMap="service_rm">
		SELECT SERVICE_NO,
		FREELANCER_NO, (SELECT MEMBER_NAME FROM "MEMBER" WHERE MEMBER_NO=FREELANCER_NO) MEMBER_NAME,
	   (SELECT MEMBER_PROFILE FROM "MEMBER" WHERE MEMBER_NO=FREELANCER_NO) MEMBER_PROFILE,
	   SERVICE_EDIT_NUM,SERVICE_WORK_PERIOD,SERVICE_CREATE_DATE, THIRD_CATEGORY_NAME, SUB_CATEGORY_NAME, MAIN_CATEGORY_NAME,
		SERVICE_TITLE,SERVICE_SUMMARY,SERVICE_PRICE,SERVICE_DEL_FL,
			THIRD_CATEGORY_NO,FREELANCER_NO,REQUEST_FILE_NO,REQUEST_FILE_PATH,MAIN_CATEGORY_NO
		FROM (SELECT * 
			FROM SERVICE
			LEFT JOIN CATEGORY USING(THIRD_CATEGORY_NO)
			LEFT JOIN SUB_CATEGORY USING(SUB_CATEGORY_NO))
			LEFT JOIN MAIN_CATEGORY USING(MAIN_CATEGORY_NO)
		LEFT JOIN (SELECT s.*,
		ROW_NUMBER() OVER (PARTITION BY SERVICE_NO ORDER BY REQUEST_FILE_NO) rum
		FROM SERVICE_FILE s) USING(SERVICE_NO)
		WHERE RUM = 1
		AND SERVICE_DEL_FL='N'
		AND SERVICE_STATUS=2
		AND SERVICE_NO=#{serviceNo}
	</select> 
	
	<select id="selectImageFileList" resultMap="imageFile_rm">
	
		SELECT * FROM SERVICE_FILE
		WHERE SERVICE_NO=#{serviceNo}
		 
	</select>
	
	<insert id="askService">
		INSERT INTO SERVICE_INQUIRY
		VALUES(SEQ_SERVICE_INQUIRY_NO.NEXTVAL,#{serviceInquiryContent},DEFAULT, #{memberNo}, #{serviceNo} )
	
	</insert>
	
	<update id="pauseService">
		UPDATE SERVICE SET SERVICE_DEL_FL='Y'
		WHERE SERVICE_NO=#{serviceNo}
	
	</update>
	
	<select id="selectSendSuggesion" resultMap="askService_rm">
		SELECT SERVICE_NO, MEMBER_NO,SERVICE_INQUIRY_CONTENT, SERVICE_TITLE, SERVICE_SUMMARY, SERVICE_INQUIRY_NO 
		FROM SERVICE_INQUIRY 
		JOIN SERVICE USING(SERVICE_NO)
		WHERE MEMBER_NO=#{memberNo}
		ORDER BY 1 DESC
	</select>
	
	
	<select id="selectSendSuggesionContent" resultMap="askService_rm">
			SELECT *
			FROM (
			   SELECT SERVICE_INQUIRY_CONTENT, SERVICE_TITLE, SERVICE_SUMMARY,
			   REQUEST_FILE_PATH,(ROW_NUMBER() OVER(PARTITION BY SERVICE_NO ORDER BY SERVICE_NO, REQUEST_FILE_PATH)) RNUM
				FROM SERVICE_FILE
				JOIN SERVICE USING(SERVICE_NO)
				JOIN SERVICE_INQUIRY USING(SERVICE_NO)
				WHERE SERVICE_INQUIRY_NO=#{serviceInquiryNo}
			) 
			WHERE RNUM =1
	</select>
	
	
	
	
	
	
	
	<select id="serviceLikeCheck" resultType="_int">
	 SELECT COUNT(*) FROM "LIKE"
	 WHERE SERVICE_NO=#{serviceNo}
	 AND MEMBER_NO=#{memberNo}
	</select>
	
	  <insert id="serviceLikeUp">
	  	INSERT INTO "LIKE"
	  	VALUES(#{serviceNo},#{memberNo})
	  </insert>
	  
		<delete id="serviceLikeDown">
	  	DELETE FROM "LIKE"
			WHERE SERVICE_NO=#{serviceNo}
			AND MEMBER_NO=#{memberNo}
	  </delete>
 
 	
 	
 	
 	
 	
 	
 	 <!-- 찜한 목록 조회 -->
   <select id="selectLikeList" resultMap="service_rm">
	 SELECT *
	FROM (
	   SELECT SERVICE_NO, REQUEST_FILE_PATH,(ROW_NUMBER() OVER(PARTITION BY SERVICE_NO ORDER BY SERVICE_NO, REQUEST_FILE_PATH)) RNUM
	   ,SERVICE_TITLE,SERVICE_SUMMARY,SERNICE_CONTENT,SERVICE_PRICE
		FROM SERVICE_FILE
		JOIN SERVICE USING(SERVICE_NO)
	) JOIN "LIKE" USING(SERVICE_NO)
	WHERE RNUM =1
	AND MEMBER_NO=#{memberNo}
	</select>
 	
 </mapper>
