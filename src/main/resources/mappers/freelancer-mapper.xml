<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="freelancerMapper">
	<!-- namespace 속성 : 현재 공간(영역)에 대한 이름 (반드시 지정!) -->
  <!-- <cache-ref namespace=""/> 무조건 삭제-->
  
  
  <!-- resultMap 태그
    - 마이바티스에서 select를 진행하는 경우
    	기본적으로 java 객체 필드명 == ResultSet 컬럼명이 같을 때 
    	자동으로 객체에 세팅이 되는데 
    	
    	다를 경우
    	컬럼 값을 어떤 필드에 세팅할 지를 지정하는 태그 
    	
    	- 속성
    	type : 연결힐 VO 객체의 타입(패키지 + 클래스명 or 별칭) 
 		myBatis-confing.xml 에서 지정
    																					
    	id : resultMap을 식별할 이름
    	
    	-->
    	<!-- mybatis-config 수정 -->
    	<!-- Freelancer -> com.manager~  -->
    	<resultMap type="Freelancer" id="freelancer_rm"> 
   
   	      <id property="freelancerNo" column="FREELANCER_NO"/>

   		  <!-- <result property="freelancerPeriod" column="FREELANCER_PERIOD" /> -->
   		  <result property="freelancerCont" column="FREELANCER_PERIOD" />
   		  <result property="contactTime1" column="FREE_CONTACT_TIME1" />
	      <result property="contactTime2" column="FREE_CONTACT_TIME2" />
	      <result property="freelancerIntro" column="FREELANCER_INTRODUCTION" />
	      <result property="regionNo" column="REGION_NO" />
	      <result property="regionName" column="REGION_NAME" />
	      <result property="gradeNo" column="GRADE_NO" />
	      <result property="mainCategoryNo" column="MAIN_CATEGORY_NO"/>
<!-- 	      <result property="mainCategoryNo" column="MAIN_CATEGORY_NO"/>
 -->	      
	      <result property="careerCompanyName" column="CAREER_COMPANY"/>
	      <result property="careerCompanyDepartment" column="CAREER_DEPARTMENT"/>
	      <result property="careerCompanyPosition" column="CAREER_POSITION"/>
	      <result property="careerCompanyRegion" column="CAREER_REGION"/>
	      <result property="careerPeriod" column="CAREER_PERIOD"/>
	      
	      <result property="licenseName" column="LICENSE_NAME"/>
	      <result property="licenseDate" column="LICENSE_DATE"/>
	      <result property="licenseAgency" column="LICENSE_AGENCY"/>
	      
	      <result property="bankName" column="BANK_NAME"/>
	      <result property="bankAccountNumber" column="ACCOUNT_NO"/>
	      
	      <result property="portfolioTitle" column="PORTFOLIO_TITLE"/>
	      <result property="portfolioContent" column="PORTFOLIO_CONTENT"/>
	      <result property="portfolioFilePath" column="PORTFOLIO_FILE_PATH"/>
    	</resultMap>
	
    	<insert id="enrollFreelancer" parameterType = "Freelancer">
    		INSERT INTO "FREELANCER"
    		VALUES(#{freelancerNo}, #{freelancerCont}, #{contactTime1}, #{contactTime2}, #{freelancerIntro},#{regionNo} ,DEFAULT)
   
    	</insert>
    	
    		<!-- 전문가 정보 조회 -->
    	<select id="freelancerInfo" parameterType="int"  resultType="Freelancer" resultMap="freelancer_rm">
			SELECT FREELANCER_INTRODUCTION,REGION_NO ,REGION_NAME, FREELANCER_PERIOD, FREE_CONTACT_TIME1, FREE_CONTACT_TIME2,
			CAREER_COMPANY, CAREER_DEPARTMENT,CAREER_POSITION,CAREER_REGION,CAREER_PERIOD,
			LICENSE_NAME, LICENSE_DATE,LICENSE_AGENCY,
			BANK_NAME,ACCOUNT_NO,
		 		(SELECT LISTAGG(MAIN_CATEGORY_NO, ',')
				WITHIN GROUP (ORDER BY MAIN_CATEGORY_NO)
				FROM(SELECT DISTINCT MAIN_CATEGORY_NO
					FROM FIELD I
					WHERE I.FREELANCER_NO = R.FREELANCER_NO) ) MAIN_CATEGORY_NO
			FROM FREELANCER R
			JOIN CAREER C ON (C.FREELANCER_NO = R.FREELANCER_NO)
			JOIN REGION USING(REGION_NO)
			JOIN LICENSE L ON (L.FREELANCER_NO = R.FREELANCER_NO)
			JOIN FREELANCER_ACCOUNT A ON(A.FREELANCER_NO = R.FREELANCER_NO)
			JOIN BANK USING(BANK_CODE)
			WHERE R.FREELANCER_NO = #{freelancerNo} 
    	</select>
    	
    	<!--  학력/전공  -->
    	<insert id="enrollFreelancerMajor" parameterType = "com.manager.freelancer.freelancer.model.vo.Major">
    		INSERT INTO "MAJOR"
    		VALUES(SEQ_MAJOR_NO.NEXTVAL, #{majorAcademyName}, #{majorName}, #{majorGraduateStatus}, #{freelancerNo})
    	</insert>
    	<!-- 프리랜서등록시 member테이블의 프리랜서_FL N값 => Y값으로 변경 -->
    	<update id="updateFreelancerFlag">
    		UPDATE "MEMBER" SET FREELANCER_FL = 'Y'
    		WHERE MEMBER_NO = #{freelancerNo}
    	</update>
   
   		<!-- 경력 사항  -->
  		<insert  id="enrollFreelancerCareer" parameterType = "com.manager.freelancer.freelancer.model.vo.Career">
  
    		INSERT INTO "CAREER" VALUES
			(SEQ_CAREER_NO.NEXTVAL, 'Y', #{careerCompanyName},#{careerCompanyDepartment},#{careerCompanyPosition},#{careerCompanyRegion},#{careerCompanyPeriod1},#{freelancerNo})	
    	</insert>
    	
    	<!--  자격증  -->
    	<insert id="enrollFreelancerLicense" parameterType = "com.manager.freelancer.freelancer.model.vo.License">
    		INSERT INTO "LICENSE"
    		VALUES(SEQ_LICENSE_NO.NEXTVAL, #{licenseName}, #{licenseDate}, #{licenseAgency}, #{freelancerNo})
    	</insert>
    	
    	
    	<!-- 계좌등록 -->
    	<insert id="insertFreelancerAccount" parameterType = "Freelancer">
    		INSERT INTO "FREELANCER_ACCOUNT"
    		VALUES(#{freelancerNo}, #{bankAccountNumber}, #{bankCode})
    	</insert>
    	
    	
    	<insert id="insertFreelancerField" parameterType = "map">
    		INSERT INTO "FIELD"
    		VALUES(#{freelancerField}, #{freelancerNo})
    	</insert>
    	
    
    	 
    	<select id="getRegionList" resultType="com.manager.freelancer.freelancer.model.vo.Region">
    		SELECT REGION_NO as regionNumber,REGION_NAME as regionName from REGION
    	</select>	
    	
    	<select id="getPortfolioList" resultType="com.manager.freelancer.freelancer.model.vo.Portfolio">
    		SELECT PORTFOLIO_TITLE as portfolioTitle, PORTFOLIO_CONTENT as portfolioContent
    		FROM  PORTFOLIO
    		WHERE FREELANCER_NO = #{freelancerNo}
    	</select>
    	
    	<select id="getFieldList" resultType="com.manager.freelancer.freelancer.model.vo.Field">
    		SELECT 
	 		(SELECT LISTAGG(MAIN_CATEGORY_NO, ',')
			WITHIN GROUP (ORDER BY MAIN_CATEGORY_NO)
			FROM(SELECT DISTINCT MAIN_CATEGORY_NO
				FROM FIELD I
				WHERE I.FREELANCER_NO = R.FREELANCER_NO) ) MAIN_CATEGORY_NO
			FROM FREELANCER R
			JOIN CAREER C ON (C.FREELANCER_NO = R.FREELANCER_NO)
			JOIN REGION USING(REGION_NO)
			JOIN LICENSE L ON (L.FREELANCER_NO = R.FREELANCER_NO)
			JOIN FREELANCER_ACCOUNT A ON(A.FREELANCER_NO = R.FREELANCER_NO)
			JOIN BANK USING(BANK_CODE)
--			JOIN FIELD USING(FREELANCER_NO)
			WHERE R.FREELANCER_NO = #{freelancerNo}
    	</select>
    	
    	<update id="updateFreelancerInfo" parameterType="Freelancer">
    		UPDATE FREELANCER SET
    		FREELANCER_INTRODUCTION = #{freelancerIntro},
    		REGION_NO =#{regionNo},
    		FREELANCER_PERIOD = #{freelancerCont},
    		FREE_CONTACT_TIME1 = #{contactTime1},
    		FREE_CONTACT_TIME2 = #{contactTime2}
    		WHERE FREELANCER_NO = #{freelancerNo}
    	</update>
    	
    	
    	<update id="updateFreelancerCareer" parameterType="Freelancer">
    		UPDATE CAREER SET
    		CAREER_COMPANY = #{careerCompanyName},
    		CAREER_DEPARTMENT = #{careerCompanyDepartment},
    		CAREER_POSITION = #{careerCompanyPosition},
    		CAREER_REGION = #{careerCompanyRegion},
    		CAREER_PERIOD = #{careerPeriod}
    		WHERE FREELANCER_NO = #{freelancerNo}
    	</update>
    	
    	
    	
    	
    	<!-- 포트폴리오 등록 -->
    	<insert id="addPortfolio"  parameterType = "Freelancer" useGeneratedKeys="true">
    		<selectKey keyProperty="portfolioNo" resultType="_int" order="BEFORE">
    			SELECT SEQ_PORTFOLIO_NO.NEXTVAL FROM DUAL
    		</selectKey>
    		INSERT INTO PORTFOLIO VALUES
    		(SEQ_PORTFOLIO_NO.NEXTVAL,#{portfolioTitle}, #{portfolioContent}, #{portfolioFilePath},#{freelancerNo})
    	</insert>
    	
    	
    	<!-- 포트폴리오 첨부파일 삽입 -->
    	<insert id ="insertPortfolioImageList" parameterType="list">
    		INSERT INTO PORTFOLIO_FILE
    		
    	
    	</insert>
</mapper>
