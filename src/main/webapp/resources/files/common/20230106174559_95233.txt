<select id="selectRoomList" resultMap="chatRoom_rm">
      SELECT CHAT_ROOM_NO
         ,(SELECT CHAT_MESSAGE FROM (
            SELECT * FROM CHAT M2
            JOIN CHAT_ROOM ON CHAT_ROOM.CHAT_ROOM_NO = M2.CHAT_ROOM_NO
            WHERE M2.CHAT_ROOM_NO = R.CHAT_ROOM_NO 
            AND (((CHAT_ROOM_OPENMEM_UPDATE_DATE IS NULL OR CHAT_SEND_TIME >= CHAT_ROOM_OPENMEM_UPDATE_DATE) AND CHAT_OPENMEM_NO = #{memberNo})
            OR  ((CHAT_ROOM_CLIENT_UPDATE_DATE IS NULL OR CHAT_SEND_TIME >= CHAT_ROOM_CLIENT_UPDATE_DATE) AND CLIENT_NO = #{memberNo}))
            ORDER BY CHAT_NO DESC) 
            WHERE ROWNUM = 1) LAST_MESSAGE
         ,TO_CHAR((SELECT 
				CASE WHEN (CHAT_OPENMEM_NO = #{memberNo} AND CHAT_ROOM_OPENMEM_UPDATE_DATE IS NULL) THEN NVL(SEND_TIME,CHAT_ROOM_CREATE_DATE)
					 WHEN (CHAT_OPENMEM_NO = #{memberNo} AND CHAT_ROOM_OPENMEM_UPDATE_DATE IS NOT NULL AND SEND_TIME > CHAT_ROOM_OPENMEM_UPDATE_DATE) THEN NVL(SEND_TIME,CHAT_ROOM_CREATE_DATE)
					 WHEN (CHAT_OPENMEM_NO = #{memberNo} AND CHAT_ROOM_OPENMEM_UPDATE_DATE IS NOT NULL AND SEND_TIME < CHAT_ROOM_OPENMEM_UPDATE_DATE) THEN CHAT_ROOM_OPENMEM_UPDATE_DATE
					 WHEN (CLIENT_NO = #{memberNo} AND CHAT_ROOM_CLIENT_UPDATE_DATE IS NULL) THEN NVL(SEND_TIME,CHAT_ROOM_CREATE_DATE)
					 WHEN (CLIENT_NO = #{memberNo} AND CHAT_ROOM_CLIENT_UPDATE_DATE IS NOT NULL AND SEND_TIME > CHAT_ROOM_CREATE_DATE) THEN NVL(SEND_TIME,CHAT_ROOM_CREATE_DATE)
					 WHEN (CLIENT_NO = #{memberNo} AND CHAT_ROOM_CLIENT_UPDATE_DATE IS NOT NULL AND SEND_TIME < CHAT_ROOM_CREATE_DATE) THEN CHAT_ROOM_CREATE_DATE
				END AS LAST_SEND_TIME
			FROM (SELECT * FROM (SELECT NVL((SELECT MAX(CHAT_SEND_TIME) CHAT_SEND_TIME 
			               FROM CHAT M
			               JOIN CHAT_ROOM ON CHAT_ROOM.CHAT_ROOM_NO = M.CHAT_ROOM_NO
			               WHERE R.CHAT_ROOM_NO  = M.CHAT_ROOM_NO), CHAT_ROOM_CREATE_DATE) SEND_TIME, CHAT_ROOM_NO
			               FROM CHAT_ROOM R
			      WHERE (CHAT_OPENMEM_NO = #{memberNo}
			      OR CLIENT_NO = #{memberNo}))
			JOIN CHAT_ROOM USING(CHAT_ROOM_NO)) M
               WHERE R.CHAT_ROOM_NO  = M.CHAT_ROOM_NO), 
               'YYYY.MM.DD HH24:MI') SEND_TIME
         ,NVL2((SELECT CHAT_OPENMEM_NO FROM CHAT_ROOM R2
            WHERE R2.CHAT_ROOM_NO = R.CHAT_ROOM_NO
            AND R2.CHAT_OPENMEM_NO = #{memberNo}),
            R.CLIENT_NO, -- NOT NULL 
            R.CHAT_OPENMEM_NO
            ) CLIENT_NO   
         ,NVL2((SELECT CHAT_OPENMEM_NO FROM CHAT_ROOM R2
            WHERE R2.CHAT_ROOM_NO = R.CHAT_ROOM_NO
            AND R2.CHAT_OPENMEM_NO = #{memberNo}),
            (SELECT MEMBER_NICKNAME FROM MEMBER WHERE MEMBER_NO = R.CLIENT_NO),
            (SELECT MEMBER_NICKNAME FROM MEMBER WHERE MEMBER_NO = R.CHAT_OPENMEM_NO)
            ) CLIENT_NICKNAME   
         ,NVL2((SELECT CHAT_OPENMEM_NO FROM CHAT_ROOM R2
            WHERE R2.CHAT_ROOM_NO = R.CHAT_ROOM_NO
            AND R2.CHAT_OPENMEM_NO = #{memberNo}),
            (SELECT MEMBER_PROFILE FROM MEMBER WHERE MEMBER_NO = R.CLIENT_NO),
            (SELECT MEMBER_PROFILE FROM MEMBER WHERE MEMBER_NO = R.CHAT_OPENMEM_NO)
            ) CLIENT_PROFILE
         ,(SELECT COUNT(*) FROM (SELECT * FROM CHAT JOIN CHAT_ROOM USING(CHAT_ROOM_NO)) M 
         	WHERE M.CHAT_ROOM_NO = R.CHAT_ROOM_NO 
         	AND READ_FL = 'N' AND SENDER_NO != #{memberNo}
         	AND ((CHAT_ROOM_OPENMEM_UPDATE_DATE IS NULL OR CHAT_SEND_TIME >= CHAT_ROOM_OPENMEM_UPDATE_DATE) AND CHAT_OPENMEM_NO = #{memberNo})
            AND ((CHAT_ROOM_CLIENT_UPDATE_DATE IS NULL OR CHAT_SEND_TIME >= CHAT_ROOM_CLIENT_UPDATE_DATE) AND CLIENT_NO = #{memberNo})) NOT_READ_COUNT
         ,(SELECT MAX(CHAT_NO) CHAT_SEND_TIME FROM CHAT M 
         WHERE R.CHAT_ROOM_NO  = M.CHAT_ROOM_NO
         AND (((CHAT_ROOM_OPENMEM_UPDATE_DATE IS NULL OR CHAT_SEND_TIME >= CHAT_ROOM_OPENMEM_UPDATE_DATE) AND CHAT_OPENMEM_NO = #{memberNo})
         OR ((CHAT_ROOM_CLIENT_UPDATE_DATE IS NULL OR CHAT_SEND_TIME >= CHAT_ROOM_CLIENT_UPDATE_DATE) AND CLIENT_NO = #{memberNo}))
         ) MAX_MESSAGE_NO,
         NVL2((SELECT CHAT_OPENMEM_NO FROM CHAT_ROOM R2
            WHERE R2.CHAT_ROOM_NO = R.CHAT_ROOM_NO
            AND R2.CHAT_OPENMEM_NO = #{memberNo}),
            (SELECT CASE WHEN FREELANCER_FL ='Y' THEN (FREE_CONTACT_TIME1||':00-'||FREE_CONTACT_TIME2||':00') ELSE NULL END AS FREE_CONTACT_TIME 
            	FROM MEMBER LEFT JOIN FREELANCER ON (MEMBER_NO=FREELANCER_NO) WHERE MEMBER_NO = R.CLIENT_NO),
            (SELECT CASE WHEN FREELANCER_FL ='Y' THEN (FREE_CONTACT_TIME1||':00-'||FREE_CONTACT_TIME2||':00') ELSE NULL END AS FREE_CONTACT_TIME 
            	FROM MEMBER LEFT JOIN FREELANCER ON (MEMBER_NO=FREELANCER_NO) WHERE MEMBER_NO = R.CHAT_OPENMEM_NO)
            ) CLIENT_FREE_CONTACT_TIME,
         NVL2((SELECT CHAT_OPENMEM_NO FROM CHAT_ROOM R2
            WHERE R2.CHAT_ROOM_NO = R.CHAT_ROOM_NO
            AND R2.CHAT_OPENMEM_NO = #{memberNo}),
            (SELECT GRADE_NAME 
            	FROM MEMBER LEFT JOIN (SELECT * FROM FREELANCER JOIN GRADE USING(GRADE_NO)) ON (MEMBER_NO=FREELANCER_NO) WHERE MEMBER_NO = R.CLIENT_NO),
            (SELECT GRADE_NAME 
            	FROM MEMBER LEFT JOIN (SELECT * FROM FREELANCER JOIN GRADE USING(GRADE_NO)) ON (MEMBER_NO=FREELANCER_NO) WHERE MEMBER_NO = R.CHAT_OPENMEM_NO)
            ) CLIENT_GRADE_NAME
      FROM CHAT_ROOM R
      WHERE (CHAT_OPENMEM_NO = #{memberNo}
      OR CLIENT_NO = #{memberNo})
      AND ((CHAT_ROOM_OPENMEM_DEL_FL = 'N' AND CHAT_OPENMEM_NO = #{memberNo})
	  OR (CHAT_ROOM_CLIENT_DEL_FL = 'N' AND CLIENT_NO = #{memberNo}))
      ORDER BY MAX_MESSAGE_NO DESC NULLS LAST
     </select>